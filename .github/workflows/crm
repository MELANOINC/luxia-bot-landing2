// crm.js — Integrador universal para tu CRM favorito (Notion, HubSpot, Google Sheets, etc)
// Usa variables del .env para elegir CRM y credenciales

const fetch = require('node-fetch');
const { CRM_PROVIDER, NOTION_KEY, NOTION_DB, HUBSPOT_KEY, SHEETS_URL } = process.env;

// Lead: { nombre, email, telefono, ticket }
async function saveLead(lead) {
  if (CRM_PROVIDER === 'notion') {
    // Notion API
    return fetch('https://api.notion.com/v1/pages', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${NOTION_KEY}`,
        'Content-Type': 'application/json',
        'Notion-Version': '2022-06-28'
      },
      body: JSON.stringify({
        parent: { database_id: NOTION_DB },
        properties: {
          Nombre: { title: [{ text: { content: lead.nombre } }] },
          Email: { email: lead.email },
          Teléfono: { rich_text: [{ text: { content: lead.telefono } }] },
          Ticket: { select: { name: lead.ticket || "N/A" } }
        }
      })
    }).then(r => r.json());
  }
  if (CRM_PROVIDER === 'hubspot') {
    // HubSpot API (contact)
    return fetch(`https://api.hubapi.com/crm/v3/objects/contacts`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${HUBSPOT_KEY}`, 'Content-Type':'application/json' },
      body: JSON.stringify({
        properties: {
          firstname: lead.nombre,
          email: lead.email,
          phone: lead.telefono,
          ticket: lead.ticket
        }
      })
    }).then(r => r.json());
  }
  if (CRM_PROVIDER === 'sheets') {
    // Google Sheets via webhook (script webapp)
    return fetch(SHEETS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(lead)
    }).then(r => r.json());
  }
  // Default: log only
  console.log('Lead recibido (solo log):', lead);
  return { ok: true };
}

module.exports = { saveLead };
